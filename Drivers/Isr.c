/*******************************************************Copyright*********************************************************
**                                            北京博创兴盛机器人技术有限公司
**                                                       研发部
**                                               http://robot.up-tech.com
**
**-------------------------------------------------------文件信息---------------------------------------------------------
** 文件名称:			Isr.c
** 最后修订日期:		2009-03-19
** 最后版本:			1.0
** 描述:				系统中断处理模块，所有功能模块间公用的中断以及系统任务调度的定时中断都将在本文件中处理。
**
**------------------------------------------------------------------------------------------------------------------------
** 创建人:			律晔
** 创建日期:			2009-03-19
** 版本:				1.0
** 描述:				 实现系统中共用中断的算法和功能模块调度的标志的查询。
**
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
** 版本:
** 描述:
**
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
** 版本:
** 描述:
**
*************************************************************************************************************************/
#include "Drivers/Isr.h"

/*************************************************************************************************************************
**                                                      外部函数声明
*************************************************************************************************************************/
extern void IsrPpmOverFlow(void);
extern void IsrAdcSampling(void);
extern void IsrGpioSampling(void);
extern void IsrSpiProcessTimerInt(void);
extern void IsrSpiProcessExtInt(void);


/*************************************************************************************************************************
** 函数名称:			SIGNAL(SYSTEM_TIMER_INT)
**
** 函数描述:			2.5ms定时中断服务函数，涉及PPM的控制，ADC采样，UpRobot协议从站处理机启动标志控制。
**
**
** 输入变量:			void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			ClrRegBit;
**
** 创建人:			律晔
** 创建日期:			2009-03-19
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
ISR(SYSTEM_TIMER_INT, ISR_NOBLOCK)
{
	timer0_control.pDisableInterrupt(TIMER8_IMR_OI);

	IsrAdcSampling();
	IsrPpmOverFlow();
	IsrGpioSampling();
	IsrSpiProcessTimerInt();

	timer0_control.pEnableInterrupt(TIMER8_IMR_OI);
}


/*************************************************************************************************************************
** 函数名称:			SIGNAL(SPI_SLAVE_INT)
**
** 函数描述:		    SPI从机请求数据发送中断
**                      
**					                 
** 输入变量:			void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			ClrRegBit;
**
** 创建人:			律晔
** 创建日期:			2009-08-17
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
ISR(SPI_SLAVE_INT, ISR_BLOCK)
{
	led_control.pChangeLedBit(0);
	IsrSpiProcessExtInt();
}


/*************************************************************************************************************************
** 函数名称:			ISR(TIMER0_OVF_vect, ISR_BLOCK)
**
** 函数描述:		    TIMER0定时中断，在此中断中进行命令解析
**
**
** 输入变量:			void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			ClrRegBit;
**
** 创建人:			律晔
** 创建日期:			2009-10-06
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
ISR(TIMER0_OVF_vect, ISR_NOBLOCK)
{
	static uint8 t = 0;

	timer0_control.pSetPrescaler(TIMER0_PRESCALE_STOP);

//	timer0_control.pDisableInterrupt(TIMER8_IMR_OI);

	timer0_control.pSetCounterRegister(TIMER0_RELOAD_VAL);

	t ++;
	if (t > 20)
	{
		t = 0;
		led_control.pChangeLedBit(1);
	}

	SystemClockTick();

//	timer0_control.pEnableInterrupt(TIMER8_IMR_OI);
	timer0_control.pSetPrescaler(TIMER0_PRESCALE_256);
}


/*************************************************************************************************************************
**                                                      文件结束
*************************************************************************************************************************/
