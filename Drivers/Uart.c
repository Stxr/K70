/*******************************************************Copyright*********************************************************
**                                            北京博创兴盛机器人技术有限公司
**                                                       研发部
**                                               http://robot.up-tech.com
**
**-------------------------------------------------------文件信息---------------------------------------------------------
** 文件名称:			Uart.c
** 最后修订日期:		2009-03-07
** 最后版本:			1.0
** 描述:				Uart的标准编成接口(API)
**
**------------------------------------------------------------------------------------------------------------------------
** 创建人:			律晔
** 创建日期:			2009-03-07
** 版本:				1.0
** 描述:				包括设备的初始化、波特率的调整、开关中断、缓冲区的用量设置等
**
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
** 版本:
** 描述:
**
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
** 版本:
** 描述:
**
*************************************************************************************************************************/
#include "Drivers/Uart.h"


/*************************************************************************************************************************
** 函数名称:			CalcBaudRate(val)
**
** 函数描述:			该函数用于计算波特率对应的BAUU值
**					                 
** 输入变量:			val(波特率)
** 返回值:			uint16
**
** 使用宏或常量:		None
** 使用全局变量:		F_CPU;
**
** 调用函数:			None
**
** 创建人:			 律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
#define CalcBaudRate1X(val)	(uint16)(F_CPU / (16 * (uint32)val) - 1)


/*************************************************************************************************************************
** 函数名称:			CalcBaudRate(val)
**
** 函数描述:			该函数用于计算波特率对应的BAUU值
**					                 
** 输入变量:			val(波特率)
** 返回值:			uint16
**
** 使用宏或常量:		None
** 使用全局变量:		F_CPU;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
#define CalcBaudRate2X(val)	(uint16)(F_CPU / (8 * (uint32)val) - 1)


/*************************************************************************************************************************
** 函数名称:			SeiUart0Rx()
**
** 函数描述:			该函数用于开启Uart0的接收中断。
**					                 
** 输入变量:			void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			SetRegBit;
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
#define 	SeiUart0Rx()	SetRegBit(UART0_UCSRB, RXCIE0)


/*************************************************************************************************************************
** 函数名称:			CliiUart0Rx()
**
** 函数描述:			该函数用于关闭Uart0的接收中断。
**					                 
** 输入变量:			void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			SetRegBit;
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
#define 	CliUart0Rx()	ClrRegBit(UART0_UCSRB, RXCIE0)

/*************************************************************************************************************************
** 函数名称:			SeiUart0Tx()
**
** 函数描述:			该函数用于开启Uart0的发送中断。
**					                 
** 输入变量:			void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			SetRegBit;
**
** 创建人:			律晔
** 创建日期:			2009-03-27
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
#define 	SeiUart0Tx()	SetRegBit(UART0_UCSRB, UDRE0)


/*************************************************************************************************************************
** 函数名称:			CliUart0Tx()
**
** 函数描述:			该函数用于关闭Uart0的发送中断。
**					                 
** 输入变量:		    void;
** 返回值:		    void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			SetRegBit;
**
** 创建人:			律晔
** 创建日期:			2009-03-27
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
#define 	CliUart0Tx()	ClrRegBit(UART0_UCSRB, UDRE0)


/*************************************************************************************************************************
** 函数名称:			SeiUart1Rx()
**
** 函数描述:			该函数用于开启Uart1的接收中断。
**					                 
** 输入变量:		    void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			SetRegBit;
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
#define 	SeiUart1Rx()	SetRegBit(UART1_UCSRB, RXCIE1)


/*************************************************************************************************************************
** 函数名称:			SeiUart1Tx()
**
** 函数描述:			该函数用于开启Uart1的发送中断。
**					                 
** 输入变量:		    void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			SetRegBit;
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
#define 	SeiUart1Tx()	SetRegBit(UART1_UCSRB, UDRE1)


/*************************************************************************************************************************
** 函数名称:			CliiUart1Rx()
**
** 函数描述:			该函数用于关闭Uart1的接收中断。
**					                 
** 输入变量:		    void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			SetRegBit;
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
#define 	CliUart1Rx()	ClrRegBit(UART1_UCSRB, RXCIE1)


/*************************************************************************************************************************
** 函数名称:			CliUart1Tx()
**
** 函数描述:			该函数用于关闭Uart1的发送中断。
**					                 
** 输入变量:		    void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:	    None;
**
** 调用函数:			SetRegBit;
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
#define 	CliUart1Tx()	ClrRegBit(UART1_UCSRB, UDRE1)


/*************************************************************************************************************************
** 函数名称:			InitUart0En()
**
** 函数描述:			初始化半双工控制接口
**					                 
** 输入变量:		    void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			SetRegBit;
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
#define InitUart0En()			\
{\
	SetRegBit(UART0_EN_DDR, UART0_RX_EN_DDR_BIT);\
	SetRegBit(UART0_EN_DDR, UART0_TX_EN_DDR_BIT);\
	SetRegBit(UART0_EN_PORT, UART0_RX_EN_PORT_BIT);\
	ClrRegBit(UART0_EN_PORT, UART0_TX_EN_PORT_BIT);\
}


/*************************************************************************************************************************
** 函数名称:			Uart0TxEn()
**
** 函数描述:			使UART总线处于发送状态
**					                 
** 输入变量:		    void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			SetRegBit;
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
#define Uart0TxEn()			\
{\
	ClrRegBit(PORTA, PA1);\
	SetRegBit(PORTA, PA0);\
}


/*************************************************************************************************************************
** 函数名称:			Uart0RxEn()
**
** 函数描述:			使UART总线处于接收状态
**					                 
** 输入变量:		    void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			SetRegBit;
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
#define Uart0RxEn()			\
{\
	ClrRegBit(UART0_EN_PORT, UART0_TX_EN_PORT_BIT);\
	SetRegBit(UART0_EN_PORT, UART0_RX_EN_PORT_BIT);\
}			


/*************************************************************************************************************************
** 函数名称:			SetUart0BaudRate
**
** 函数描述:			该函数用于设置UART0的波特率
**					                 
** 输入变量:		    mode(模式，UART_BAUDRATE_1X或UART_BAUDRATE_2X), baud(波特率)
** 返回值:			void;
**
** 使用宏或常量:		None
** 使用全局变量:	    None;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static void SetUart0BaudRate(uint8 mode, uint32 baud)
{
	if(UART_BAUDRATE_1X == mode)
	{
		ClrRegBit(UART0_UCSRA, UART_U2X_BIT);
		Out16(UART0_UBRR_L, UART0_UBRR_H, CalcBaudRate1X(baud));					// 设定波特率
	}
	else
	{
		SetRegBit(UART0_UCSRA, UART_U2X_BIT);
		Out16(UART0_UBRR_L, UART0_UBRR_H, CalcBaudRate2X(baud));					// 设定波特率
	}
}


/*************************************************************************************************************************
** 函数名称:			SetUart1BaudRate
**
** 函数描述:			该函数用于设置UART1的波特率
**					                 
** 输入变量:		    baud(波特率)
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static void SetUart1BaudRate(uint8 mode, uint32 baud)
{
	if(UART_BAUDRATE_1X == mode)
	{
		ClrRegBit(UART1_UCSRA, UART_U2X_BIT);
		Out16(UART1_UBRR_L, UART1_UBRR_H, CalcBaudRate1X(baud));					// 设定波特率
	}
	else
	{
		SetRegBit(UART1_UCSRA, UART_U2X_BIT);
		Out16(UART1_UBRR_L, UART1_UBRR_H, CalcBaudRate2X(baud));					// 设定波特率
	}
}


/*************************************************************************************************************************
** 函数名称:			SendUart0byte
**
** 函数描述:			该函数用于从uart0发送数据
**					                 
** 输入变量:		    val;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static void SendUart0Byte(uint8 val)
{
	#if UART0_BSU_EN
		Uart0TxEn();
	#endif
	
	#if UART0_ISR_MODE
		while (!GetRegBit(UART0_UCSRA, UDRE0));
		SetReg(UART0_UDR, val);
	#else
		SetRegBit(UCSR0A, TXC0);						// 清除UART0写完成标志

		while (!GetRegBit(UART0_UCSRA, UDRE0));
		SetReg(UART0_UDR, val);

		while (!GetRegBit(UCSR0A, TXC0));				// 等待发送完成

		Uart0RxEn();
	#endif


}

/*************************************************************************************************************************
** 函数名称:			SendUart1byte
**
** 函数描述:			该函数用于从uart1发送数据
**					                 
** 输入变量:		    val;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static void SendUart1Byte(uint8 val)
{
	if(buffer_queue_control.pTestEmpty(&uart1_control.str_tx_buffer))
	{
		buffer_queue_control.pAdd(&uart1_control.str_tx_buffer, val);
		SeiUart1Tx();
	}
	else
	{	
		buffer_queue_control.pAdd(&uart1_control.str_tx_buffer, val);
	}
}


/*************************************************************************************************************************
** 函数名称:			WriteUart0TxBuffer
**
** 函数描述:			将数据写入UART0的发送缓冲队列
**					                 
** 输入变量:		    val;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static void WriteUart0TxBuffer(uint8 val)
{
	buffer_queue_control.pAdd(&uart0_control.str_tx_buffer, val);
}


/*************************************************************************************************************************
** 函数名称:			WriteUart1TxBuffer
**
** 函数描述:			将数据写入UART1的发送缓冲队列
**					                 
** 输入变量:			val;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static void WriteUart1TxBuffer(uint8 val)
{
	buffer_queue_control.pAdd(&uart1_control.str_tx_buffer, val);
}


/*************************************************************************************************************************
** 函数名称:			SentUart0TxBuffer
**
** 函数描述:			将发送缓冲队列中的数据发送
**					                 
** 输入变量:		    void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static void SendUart0TxBuffer(void)
{
	#if !UART0_ISR_MODE
		uint8 temp_val = 0;
	#endif

	
	#if UART0_BSU_EN
		Uart0TxEn();
	#endif



	#if UART0_ISR_MODE
		SeiUart0Tx();
	#else
		// 非中断方式，关全局中断很重要，否则总线方向可能提前被切换为接收

		while(buffer_queue_control.pOut(&uart0_control.str_tx_buffer, &temp_val))
		{
			while (!GetRegBit(UART0_UCSRA, UDRE0));
			SetRegBit(UCSR0A, TXC0);						// 清除UART0写完成标志
			SetReg(UART0_UDR, temp_val);
		}

		while (!GetRegBit(UCSR0A, TXC0));				// 等待发送完成

		Uart0RxEn();

	#endif

}


/*************************************************************************************************************************
** 函数名称:			SentUart1TxBuffer
**
** 函数描述:			将发送缓冲队列中的数据发送
**					                 
** 输入变量:		    void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static void SendUart1TxBuffer(void)
{
	SeiUart1Tx();
}


/*************************************************************************************************************************
** 函数名称:			ClearUart1RxBuffer
**
** 函数描述:			将发送缓冲队列中的数据发送
**
** 输入变量:		    void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static void ClearUart1ReceiveBuffer(void)
{
	buffer_queue_control.pClear(&uart1_control.str_rx_buffer);
}


/*************************************************************************************************************************
** 函数名称:			ClearUart0RxBuffer
**
** 函数描述:			将发送缓冲队列中的数据发送
**
** 输入变量:		    void;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None;
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static void ClearUart0ReceiveBuffer(void)
{
	buffer_queue_control.pClear(&uart0_control.str_rx_buffer);
}


/*************************************************************************************************************************
** 函数名称:			ReceiveUart0Byte
**
** 函数描述:			该函数用于从uart0接收数据
**					                 
** 输入变量:		    val;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static uint8 ReceiveUart0Byte(uint8 *val)
{
	if(buffer_queue_control.pOut(&uart0_control.str_rx_buffer, val))
	{
		return TRUE;
	}
	else
	{
		return FALSE;
	}
}


/*************************************************************************************************************************
** 函数名称:			ReceiveUart1Byte
**
** 函数描述:			该函数用于从uart1接收数据
**					                 
** 输入变量:		    val;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static uint8 ReceiveUart1Byte(uint8 *val)
{
	if(buffer_queue_control.pOut(&uart1_control.str_rx_buffer, val))
	{
		return TRUE;
	}
	else
	{
		return FALSE;
	}
}


/*************************************************************************************************************************
** 函数名称:			TestReceiveUart0
**
** 函数描述:			该函数用于判断接收缓冲区是否存在数据，存在返回TURE，不存在返回FALSE
**					                 
** 输入变量:		    void;
** 返回值:			uint8;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-17
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static uint8 TestUart0ReceiveBuffer(void)
{
	if(buffer_queue_control.pTestEmpty(&uart0_control.str_rx_buffer))
	{
		return FALSE;
	}
	else
	{
		return TRUE;
	}
}


/*************************************************************************************************************************
** 函数名称:			TestReceiveUart1
**
** 函数描述:			该函数用于判断接收缓冲区是否存在数据，存在返回TURE，不存在返回FALSE
**					                 
** 输入变量:		    void;
** 返回值:		    uint8;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-17
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static uint8 TestUart1ReceiveBuffer(void)
{
	if(buffer_queue_control.pTestEmpty(&uart1_control.str_rx_buffer))
	{
		return FALSE;
	}
	else
	{
		return TRUE;
	}
}


/*************************************************************************************************************************
** 函数名称:			InitUart0
**
** 函数描述:			uart0初始化函数
**                      
**                      
**					                 
** 输入变量:			void
** 返回值:			void
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			InitBufferQueue; Out16;
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static void InitUart0(void)
{
	SetReg(uart0_control.state , 0);
	
	buffer_queue_control.pInit(&uart0_control.str_rx_buffer, 64);						// 初始化缓冲区
	buffer_queue_control.pInit(&uart0_control.str_tx_buffer, 192);
	
	if (!GetRegBit(uart0_control.str_rx_buffer.state, INIT_COMPLETE)
		|| !GetRegBit(uart0_control.str_rx_buffer.state, INIT_COMPLETE))				// 检查队列空间是否分配成功
	{
		SetRegMask(uart0_control.state, ERR_MASK, ERR_NOTAVAIL);						// 置错误类型标志位
		return;
	}

	ClrRegBit(UART0_DDR, UART0_RX_DDR_BIT);
	ClrRegBit(UART0_DDR, UART0_TX_DDR_BIT);
	
	ClrRegBit(UART0_PORT, UART0_RX_PORT_BIT);
	ClrRegBit(UART0_PORT, UART0_TX_PORT_BIT);
	
	#if UART0_BSU_EN
		InitUart0En();
	#endif
	
	
	Out16(UART0_UBRR_L, UART0_UBRR_H, CalcBaudRate2X(UART0_BAUDRATE));      				// 设定波特率
	SetRegBit(UART0_UCSRA, U2X0);

	ClrRegBit(UART0_UCSRA, MPCM0);															// 普通模式
	
	SetRegBit(UART0_UCSRB, RXEN0);
	SetRegBit(UART0_UCSRB, TXEN0);															// 接收器与发送器使能
							
	ClrRegBit(UART0_UCSRB, UCSZ02);	
																							// 设置帧格式: 8 个数据位,无奇偶效验位,1个停止位
	SetRegBit(UART0_UCSRC, UCSZ01);
	SetRegBit(UART0_UCSRC, UCSZ00);
	
	ClrRegBit(UART0_UCSRB, RXCIE0);															// 接收与发送中断禁止
	ClrRegBit(UART0_UCSRB, UDRE0);
	
	#if UART0_BSU_EN && UART0_ISR_MODE

		SetRegBit(UART0_UCSRB, TXCIE0);														// 开发送完成中断

	#else
	
		ClrRegBit(UART0_UCSRB, TXCIE0);
	
	#endif
				
	uart0_control.pSetBaudRate = SetUart0BaudRate;											// 初始化波特率设置函数
	uart0_control.pSendByte = SendUart0Byte;												// 初始化发送函数
	uart0_control.pReceiveByte = ReceiveUart0Byte;											// 初始化接收函数
	uart0_control.pWriteTxBuffer = WriteUart0TxBuffer;										// 初始化入缓冲队列函数
	uart0_control.pSendTxBuffer = SendUart0TxBuffer;										// 初始化发送缓冲队列函数
	uart0_control.pTestReceiveBuffer = TestUart0ReceiveBuffer;								// 初始化测试接收缓冲函数
	uart0_control.pClearReceiveBuffer = ClearUart0ReceiveBuffer;

	SeiUart0Rx();
	
	SetRegBit(uart0_control.state, INIT_COMPLETE);											// 置位初始化完成标志
}


/*************************************************************************************************************************
** 函数名称:			InitUart1
**
** 函数描述:			uart1初始化函数
**                      
**                      
**					                 
** 输入变量:			void
** 返回值:			void
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			InitBufferQueue; Out16;
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
static void InitUart1(void)
{
	SetReg(uart1_control.state , 0);
	
	buffer_queue_control.pInit(&uart1_control.str_rx_buffer, 255);							// 初始化缓冲区
	buffer_queue_control.pInit(&uart1_control.str_tx_buffer, 128);
	 
	if (!GetRegBit(uart1_control.str_rx_buffer.state, INIT_COMPLETE)
		|| !GetRegBit(uart1_control.str_rx_buffer.state, INIT_COMPLETE))					// 检查队列空间是否分配成功
	{
		SetRegMask(uart1_control.state, ERR_MASK, ERR_NOTAVAIL);							// 置错误类型标志位
		return;
	}

	ClrRegBit(UART1_DDR, UART1_RX_DDR_BIT);
	ClrRegBit(UART1_DDR, UART1_TX_DDR_BIT);
	
	ClrRegBit(UART1_PORT, UART1_RX_PORT_BIT);
	ClrRegBit(UART1_PORT, UART1_TX_PORT_BIT);

	Out16(UART1_UBRR_L, UART1_UBRR_H, CalcBaudRate2X(UART1_BAUDRATE));      				// 设定波特率
			
	SetRegBit(UART1_UCSRA, U2X1);
	ClrRegBit(UART1_UCSRA, MPCM1);								     						// 2X模式
	
	SetRegBit(UART1_UCSRB, RXEN1);
	SetRegBit(UART1_UCSRB, TXEN1);								     						// 接收器与发送器使能
	
	ClrRegBit(UART1_UCSRB, UCSZ12);								     						// 设置帧格式: 8 个数据位,无奇偶效验位,1个停止位
	SetRegBit(UART1_UCSRC, UCSZ11);
	SetRegBit(UART1_UCSRC, UCSZ10);
	
	ClrRegBit(UART1_UCSRB, RXCIE1);								     						// 接收与发送中断禁止
	ClrRegBit(UART1_UCSRB, TXCIE1);
	ClrRegBit(UART1_UCSRB, UDRE1);
		
	uart1_control.pSetBaudRate = SetUart1BaudRate;					
	uart1_control.pSendByte = SendUart1Byte;					     						// 初始化发送函数
	uart1_control.pReceiveByte = ReceiveUart1Byte;
	uart1_control.pWriteTxBuffer = WriteUart1TxBuffer;			     						// 初始化入缓冲队列函数
	uart1_control.pSendTxBuffer = SendUart1TxBuffer;			     						// 初始化发送缓冲队列函数
	uart1_control.pTestReceiveBuffer = TestUart1ReceiveBuffer;								// 初始化测试接收缓冲函数
	uart1_control.pClearReceiveBuffer = ClearUart1ReceiveBuffer;
	
	SeiUart1Rx();

	SetRegBit(uart1_control.state , INIT_COMPLETE);											// 置位初始化完成标志
}


/*************************************************************************************************************************
** 函数名称:			SIGNAL(SIG_UART0_TRANS)
**
** 函数描述:		    uart0的发送完成中断服务函数
**					                 
** 输入变量:		    val;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
ISR(USART0_TX_vect, ISR_BLOCK)
{
	if(buffer_queue_control.pTestEmpty(&uart0_control.str_tx_buffer))
	{
		Uart0RxEn();
	}
}


/*************************************************************************************************************************
** 函数名称:			SIGNAL(SIG_UART0_RECV)
**
** 函数描述:		    uart0的接收中断服务函数
**					                 
** 输入变量:		    val;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
ISR(USART0_RX_vect, ISR_BLOCK)
{
	buffer_queue_control.pAdd(&uart0_control.str_rx_buffer, UART0_UDR);
}


/*************************************************************************************************************************
** 函数名称:			SIGNAL(SIG_UART1_RECV)
**
** 函数描述:		    uart1的接收中断服务函数
**					                 
** 输入变量:		    val;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:	    None;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
ISR(USART1_RX_vect, ISR_BLOCK)
{
	buffer_queue_control.pAdd(&uart1_control.str_rx_buffer, UART1_UDR);
}


/*************************************************************************************************************************
** 函数名称:			SIGNAL(SIG_UART0_DATA)
**
** 函数描述:		    uart0的发送缓冲空中断服务函数
**					                 
** 输入变量:		    val;
** 返回值:			void;
**
** 使用宏或常量:		None;
** 使用全局变量:	    None;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
ISR(USART0_UDRE_vect, ISR_BLOCK)
{
	uint8 temp_val = 0;

	if(buffer_queue_control.pOut(&uart0_control.str_tx_buffer, &temp_val))
	{
		SetReg(UART0_UDR, temp_val);
	}
	else
	{
		CliUart0Tx();
	}
}


/*************************************************************************************************************************
** 函数名称:			SIGNAL(SIG_UART1_DATA)
**
** 函数描述:		    uart1的发送缓冲空中断服务函数
**					                 
** 输入变量:		    val;
** 返回值:		    void;
**
** 使用宏或常量:		None;
** 使用全局变量:		None;
**
** 调用函数:			None
**
** 创建人:			律晔
** 创建日期:			2009-03-07
**------------------------------------------------------------------------------------------------------------------------
** 修订人:
** 修订日期:
**------------------------------------------------------------------------------------------------------------------------
*************************************************************************************************************************/
ISR(USART1_UDRE_vect, ISR_BLOCK)
{
	uint8 temp_val = 0;

	if(buffer_queue_control.pOut(&uart1_control.str_tx_buffer, &temp_val))
	{
		SetReg(UART1_UDR, temp_val);
	}
	else
	{
		CliUart1Tx();
	}
}


/*************************************************************************************************************************
** 														结构体声明
*************************************************************************************************************************/
UART_CONTROL_STRUCT uart0_control = { .pInit = InitUart0 };
UART_CONTROL_STRUCT uart1_control = { .pInit = InitUart1 };
//以下是小螃蟹写的结构体
UART_CONTROL_STRUCT uart0_test ={
		.pInit =InitUart0,
		.pSetBaudRate = SetUart0BaudRate,
		.pWriteTxBuffer=WriteUart0TxBuffer,
		.pSendTxBuffer=SendUart0TxBuffer,
};
UART_CONTROL_STRUCT uart1_test ={
		.pInit =InitUart1,
		.pSetBaudRate = SetUart1BaudRate,
		.pWriteTxBuffer=WriteUart1TxBuffer,
		.pSendTxBuffer=SendUart1TxBuffer,
};
/*************************************************************************************************************************
**                                                      文件结束
*************************************************************************************************************************/
